# nikolay-semenov_infra
bastion_IP = 35.207.182.230
someinternalhost_IP = 10.156.11.4

## Задание: знакомство с облачной инфраструктурой GCP

### В рамках задания, было поставлены следующие задачи:

1. Развернуть облачную сеть;

2. Развернуть два инстанса - bastion (с публичным адресом), instance-1 без публичного адреса;

2.1. В дальнейшем, планировалось использовать bastion как jump-host к instance-1 и укаазать, как осуществить подключение в одну строку;

3. Настроить схему подключения с использованием стороннего ресурса pritunl

### Решение поставленных задач:

1, 2. Развернуть облачную сеть и два инстанса: bastion, instance-1

Для решения данной задачи, было решено описать инфраструктуру согласно концепции IaC с использованием terraform. В качестве структуры каталогов,
было решено использовать модульную архитектуру, в которой мы имеем два каталога:

tf-infra-plan - позволяет нам динамически описывать инфраструктуру с использованием уже подготовленных модулей, вся работа plan\apply\destroy происходит из этого каталога

tf-infra-modules - позволяет нам подготовить инфраструктуру и переиспользовать её для разных сред, линейно расширяя и добавляя необходимые нам ресурсы

### Как использовать:

- Устанавливаем terraform https://learn.hashicorp.com/terraform/getting-started/install.html#installing-terraform

- Перейдя в tf-infra-plan инициализируем репозиторий terraform: terraform init

- Подставляем в переменные main.tf необходимые нам значения

- Экспортируем переменные для ключа доступа GCP: export GOOGLE_CLOUD_KEYFILE_JSON=/path/to/key.json

- terraform plan

- terrafirm apply

### Возможные проблемы:

- После запуска terraform apply 400 ошибка Api google, говорящая нам об отсутсвии VPC

- После запуска terraform destory 400 ошибка API google, говорящая нам об использовании VPC

### Решение:

Т.к. timeoute в модуле VPC не доступен, единственное рабочее решение которое удалось найти: повторный запуск apply\plan после данной ошибки

2.1. Использование bastion-host в качестве jump-host к instance-1 и подключение в одну строку

- Сразу настраиваем aliase в .ssh/config

Host gcp-bastion
  Hostname 35.207.182.230
  User user
  IdentityFile ~/.ssh/path/to/key

Host gcp-instance
  Hostname 10.156.11.4
  User user

- Подключаемся коммандой: ssh -A -J gcp-bastion gcp-instance

3. Настройка pritunl

- Выполнена, все необходимые для проверки travis-ci дейвствия выполнены.
